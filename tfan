#define RX PA5
#define TX PA6
#define fanControl PA7
#define manualButton PA8
#define LED PC13

#define console Serial.println

unsigned long currentTick = 0;
unsigned long previousTick = 0;
unsigned long buttonLastTimePressedTick = 0;
unsigned long fanEnableStartTimeTick = 0;

const unsigned long hardwareRestartTime = 14 * 24 * 60 * 60 * 1000;  //first number is count of days
const unsigned long pauseTime = 1 * 1000;                            //1 second

const float maxDistance = 150;

float distance = 0;

const uint8_t maxCounter = 6;

uint8_t counter = 0;
uint8_t buttonPressedCount = 0;
uint8_t lastButtonPressedCount = 0;

uint32_t minutes = 2 * 60 * 1000;  //2 minutes
uint32_t seconds = 30 * 1000;      //30 seconds
uint32_t fanEnableTime = minutes + seconds;

bool isEntityDetected = false;
bool isFanEnabled = false;
bool isNeedToEnableFan = false;
bool isSystemDisabled = false;
bool isButtonPressed = false;

String systemState = "";


void setup() {
  // put your setup code here, to run once:
  Serial.begin(115200);
  pinMode(RX, INPUT);
  pinMode(TX, OUTPUT);
  pinMode(LED, OUTPUT);
  pinMode(fanControl, OUTPUT);
  pinMode(manualButton, INPUT);

  digitalWrite(TX, LOW);
  digitalWrite(fanControl, LOW);
  digitalWrite(LED, HIGH);

  attachInterrupt(manualButton, buttonInterrupt, FALLING);
}

void loop() {

  currentTick = millis();

  if (!isSystemDisabled) {
    getDistanceUltrasonucSensor();
    entityPresenceCounter();
    entityAbsenceCounter();
    enableFan();
  }

  buttonHandler();
  checkWorkTime();
  displaySystemStatus();
}

void entityPresenceCounter() {
  if (!isEntityDetected && !isNeedToEnableFan && (currentTick - previousTick) > pauseTime) {
    if (distance < maxDistance) {
      ledBlink(30, 1);
      counter++;
    } else {
      if (counter > 0) {
        counter--;
      }
    }
  }
  if (counter > maxCounter) {
    isEntityDetected = true;
    counter = 0;
  }
}

void entityAbsenceCounter() {
  if (isEntityDetected && !isNeedToEnableFan && (currentTick - previousTick) > pauseTime) {
    if (distance > maxDistance) {
      ledBlink(30, 2);
      counter++;
      if (counter > maxCounter) {
        isEntityDetected = false;
        isNeedToEnableFan = true;
        counter = 0;
      }
    } else {
      counter = 0;
    }
  }
}

void enableFan() {
  if (isSystemDisabled) {
    goto interruptedFanFlag;
  }
  if (isNeedToEnableFan) {
    if (!isFanEnabled) {
      digitalWrite(fanControl, HIGH);
      isFanEnabled = true;
      fanEnableStartTimeTick = currentTick;
    }
    if ((currentTick - fanEnableStartTimeTick) > fanEnableTime) {
interruptedFanFlag:
      if (isFanEnabled) {
        digitalWrite(fanControl, LOW);
        isFanEnabled = false;
      }
      isNeedToEnableFan = false;
    }
  } else {
    goto interruptedFanFlag;
  }
}

void getDistanceUltrasonucSensor() {
  //pause to prevert problems with echo
  if ((currentTick - previousTick) > pauseTime) {
    previousTick = currentTick + 10;
    // 10mks impulse
    digitalWrite(TX, HIGH);
    delayMicroseconds(10);  //10 default
    digitalWrite(TX, LOW);

    // echo impulse time measure
    uint32_t us = pulseIn(RX, HIGH);

    distance = us / 58.2;
  }
}


void buttonInterrupt() {
  if ((currentTick - buttonLastTimePressedTick) > 220) {
    buttonLastTimePressedTick = currentTick;
    buttonPressedCount++;
    isButtonPressed = true;
    console("button press interrupt event count: " + (String)buttonPressedCount);
  }
}

void buttonHandler() {
  if (isButtonPressed) {
    if ((currentTick - buttonLastTimePressedTick) > 2000) {
      switch (buttonPressedCount) {
        case 1:
          {
            console("handle button case 1");
            break;
          }
        case 2:
          {
            console("handle button case 2");
            isNeedToEnableFan = true;
            fanEnableStartTimeTick = currentTick;
            break;
          }
        case 3:
          {
            console("handle button case 3");
            isNeedToEnableFan = false;
            isEntityDetected = false;
            counter = 0;
            break;
          }
        case 4:
          {
            console("handle button case 4");
            isSystemDisabled = true;
            digitalWrite(LED, LOW);
            break;
          }
        default:
          {
            console("handle button case default and clear interrupted flag");
            isSystemDisabled = false;
            digitalWrite(LED, HIGH);
            break;
          }
      }
      isButtonPressed = false;
      lastButtonPressedCount = buttonPressedCount;
      buttonPressedCount = 0;
    }
  }
}

void checkWorkTime() {
  if (currentTick > hardwareRestartTime) {
    HAL_NVIC_SystemReset();
  }
}

void ledBlink() {
  //FUUUUUUUUUU
  if (digitalRead(LED) == HIGH) {
    digitalWrite(LED, LOW);
    delay(25);
    digitalWrite(LED, HIGH);
  } else {
    digitalWrite(LED, HIGH);
    delay(25);
    digitalWrite(LED, LOW);
  }
}

void ledBlink(uint8_t ledPauseTime, uint8_t repitCount) {
  while (repitCount > 0) {
    digitalWrite(LED, LOW);
    delay(ledPauseTime);
    digitalWrite(LED, HIGH);
    delay(ledPauseTime);
    repitCount--;
  }
}

void displaySystemStatus() {
  if ((currentTick - previousTick) > pauseTime) {
    systemState = "Current system state: \n\t distance: " + (String)distance + "\n\t current counter: " + (String)counter + "\n\t isEntityDetected: " + (String)isEntityDetected + "\n\t isNeedToEnableFan: " + (String)isNeedToEnableFan + "\n\t isFanEnabled: " + (String)isFanEnabled + "\n\t isSystemDisabled: " + (String)isSystemDisabled + "\n\t lastButtonPressedCount: " + (String)lastButtonPressedCount;
    console(systemState);
  }
}
