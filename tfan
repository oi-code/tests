#define RX PA5
#define TX PA6
#define fanControl PA7
#define button PA8
#define systemBlueLed PC13
#define whiteLed PA9

#define console Serial.println

unsigned long currentTick = 0;
unsigned long previousTick = 0;
unsigned long buttonLastTimePressedTick = 0;
unsigned long fanEnableStartTimeTick = 0;

const unsigned long hardwareRestartTime = 14 * 24 * 60 * 60 * 1000;  //first number is count of days
const unsigned long pauseTime = 1 * 1000;                            //1 second

const float maxDistance = 150;

float distance = 0;

const uint8_t maxCounter = 6;

uint8_t counter = 0;
uint8_t _counter = 0;
uint8_t buttonPressedCount = 0;
uint8_t lastButtonPressedCount = 0;

uint32_t minutes = 2 * 60 * 1000;  //2 minutes
uint32_t seconds = 30 * 1000;      //30 seconds
uint32_t fanEnableTime = minutes + seconds;

bool isEntityDetected = false;
bool isFanEnabled = false;
bool isNeedToEnableFan = false;
bool isSystemDisabled = false;
bool isButtonPressed = false;
bool isNeedToDisplayStatus = false;

String systemState = "";


void setup() {
  // put your setup code here, to run once:
  Serial.begin(115200);
  pinMode(RX, INPUT);
  pinMode(TX, OUTPUT);
  pinMode(systemBlueLed, OUTPUT);
  pinMode(whiteLed, OUTPUT);
  pinMode(fanControl, OUTPUT);
  pinMode(button, INPUT);

  digitalWrite(TX, LOW);
  digitalWrite(fanControl, LOW);
  digitalWrite(systemBlueLed, HIGH);
  digitalWrite(whiteLed, LOW);

  attachInterrupt(button, buttonInterrupt, FALLING);
}

void loop() {

  currentTick = millis();

  if (!isSystemDisabled) {
    getDistanceUltrasonucSensor();
    entityPresenceCounter();
    entityAbsenceCounter();
    enableFan();
  }

  buttonHandler();
  checkWorkTime();

  if (isNeedToDisplayStatus) {
    displaySystemStatus();
  }
}

void entityPresenceCounter() {
  if ((currentTick - previousTick) > pauseTime) {
    if (distance < maxDistance) {
      blinkSystemBlueLed(50, 1);
      counter++;
    } else {
      if (counter > 0) {
        counter--;
      }
    }
    if (counter > maxCounter) {
      if (!isNeedToEnableFan) {
        isEntityDetected = true;
      }
      fanEnableStartTimeTick = currentTick;
      counter = 0;
    }
  }
}

void entityAbsenceCounter() {
  if (isEntityDetected && !isNeedToEnableFan && (currentTick - previousTick) > pauseTime) {
    if (distance > maxDistance) {
      blinkSystemBlueLed(50, 2);
      _counter++;
      if (_counter > maxCounter) {
        isEntityDetected = false;
        isNeedToEnableFan = true;
        _counter = 0;
      }
    } else {
      _counter = 0;
    }
  }
}

void enableFan() {
  if (isSystemDisabled) {
    goto interruptedFanFlag;
  }
  if (isNeedToEnableFan) {
    if (!isFanEnabled) {
      digitalWrite(fanControl, HIGH);
      isFanEnabled = true;
      fanEnableStartTimeTick = currentTick;
    }
    if ((currentTick - fanEnableStartTimeTick) > fanEnableTime) {
interruptedFanFlag:
      if (isFanEnabled) {
        digitalWrite(fanControl, LOW);
        isFanEnabled = false;
      }
      isNeedToEnableFan = false;
    }
  } else {
    goto interruptedFanFlag;
  }
}

void getDistanceUltrasonucSensor() {
  //pause to prevert problems with echo
  if ((currentTick - previousTick) > pauseTime) {
    previousTick = currentTick + 10;
    // 10mks impulse
    digitalWrite(TX, HIGH);
    delayMicroseconds(10);  //10 default
    digitalWrite(TX, LOW);

    // echo impulse time measure
    uint32_t us = pulseIn(RX, HIGH);

    distance = us / 58.2;
  }
}


void buttonInterrupt() {
  if ((currentTick - buttonLastTimePressedTick) > 50) {
    buttonLastTimePressedTick = currentTick;
    buttonPressedCount++;
    isButtonPressed = true;
    blinkWhiteLed(40, 1);
    console("button press interrupt event count: " + (String)buttonPressedCount);
  }
}

void buttonHandler() {
  if (isButtonPressed) {
    if ((currentTick - buttonLastTimePressedTick) > 1500) {
      switch (buttonPressedCount) {
        case 1:
          {
            console("handle button case 1: ignore");
            break;
          }
        case 2:
          {
            console("handle button case 2: disable fan");
            isNeedToEnableFan = false;
            isEntityDetected = false;
            counter = 0;
            _counter = 0;
            break;
          }
        case 3:
          {
            console("handle button case 3: enable fan");
            isNeedToEnableFan = true;
            break;
          }
        case 4:
          {
            console("handle button case 4: switch system disable");
            isSystemDisabled = !isSystemDisabled;
            if (digitalRead(systemBlueLed) == LOW) {
              digitalWrite(systemBlueLed, HIGH);
            } else {
              digitalWrite(systemBlueLed, LOW);
            }
            break;
          }
        case 5:
          {
            console("handle button case 5: switch display status");
            isNeedToDisplayStatus = !isNeedToDisplayStatus;
            break;
          }
        default:
          {
            console("handle button case default");
            isSystemDisabled = false;
            digitalWrite(systemBlueLed, HIGH);
            break;
          }
      }
      isButtonPressed = false;
      lastButtonPressedCount = buttonPressedCount;
      buttonPressedCount = 0;
    }
  }
}

void checkWorkTime() {
  if (currentTick > hardwareRestartTime) {
    HAL_NVIC_SystemReset();
  }
}

void blinkSystemBlueLed() {
  //FUUUUUUUUUU
  if (digitalRead(systemBlueLed) == HIGH) {
    digitalWrite(systemBlueLed, LOW);
    delay(25);
    digitalWrite(systemBlueLed, HIGH);
  } else {
    digitalWrite(systemBlueLed, HIGH);
    delay(25);
    digitalWrite(systemBlueLed, LOW);
  }
}

void blinkSystemBlueLed(uint8_t ledPauseTime, uint8_t repitCount) {
  while (repitCount > 0) {
    digitalWrite(systemBlueLed, LOW);
    delay(ledPauseTime);
    digitalWrite(systemBlueLed, HIGH);
    delay(ledPauseTime);
    repitCount--;
  }
}

void blinkWhiteLed(uint8_t ledPauseTime, uint8_t repitCount) {
  while (repitCount > 0) {
    digitalWrite(whiteLed, HIGH);
    delay(ledPauseTime);
    digitalWrite(whiteLed, LOW);
    delay(ledPauseTime);
    repitCount--;
  }
}

void displaySystemStatus() {
  if ((currentTick - previousTick) > pauseTime) {
    systemState = "Current system state: \n\t distance: " + (String)distance + "\n\t current counter: " + (String)counter + "\n\t isEntityDetected: " + (String)isEntityDetected + "\n\t isNeedToEnableFan: " + (String)isNeedToEnableFan + "\n\t isFanEnabled: " + (String)isFanEnabled + "\n\t isSystemDisabled: " + (String)isSystemDisabled + "\n\t lastButtonPressedCount: " + (String)lastButtonPressedCount;
    console(systemState);
  }
}
